# Pi.Response (Gestore delle risposte del server) ver 1.2

La libreria response mette a disposizione la variabile `$pr` in tutti le chiamate dei moduli, e si occupa della gestione delle risposte che poi devo essere eseguite dal client.

La libreria javascipt `Pi.JS` mette a disposizione le funzioni per eseguire le chiamate ajax al server, e la Response si occupa sia di interpretare la richiesta, che di formattare la risposta in modo che le istruzioni siano eseguite in modo corretto.

Lo scope della variabile globale sono solamente i file contenuti nelle cartelle `call` dei moduli e viene inizializzata dalla pagina `remote.php` (o dalla libreria `Pi.RemoteLoader.php`) che si occupa di configurarla correttamente.

## Funzioni per il recupero delle variabili lato client

Le seguenti funzioni si occupano di recuperare le variabili passate dal client tramite le funzioni di `pi.request` o `pi.download`

### post
```php
	$pr->post( $iVar )
	$pr->post( $iVar, $iDefault )
```
> **iVar** (*string*) : nome della variabile passata in post dal client  
> **iDefault** (*string*) : valore da restituire in caso di assenza della variabile

La funzione ritorna la variabile passata in post tramite le funzioni di `pi.request`.  
Se viene passato un solo parametro e la variabile non è presente nel json della comunicazione, allora la chiamata viene terminata con messaggio di errore a video che indica la richiesta di una variabile non presente. Se invece viene valorizzato anche il secondo parametro, la funzione non darà nessun errore, ma nel caso non sia presente la variabile `$iVar` verrà restituito il valore `$iDefault`.

### getString
```php
	$pr->getString( $iVar )
	$pr->getString( $iVar, $iFlags )
```
> **iVar** (*string*) : nome della variabile passata in post dal client  
> **iFlags** (*number/constants*) :
> - **$pr::GET_STR_UPPER** : Mette la stringa in uppercase
> - **$pr::GET_STR_SQLSAFE** : Elimina i caratteri speciali e raddoppia gli apici (sostituisce anche * con %)
> 	- **$pr::GET_STR_NOASTERIX** : Evita di sostituire * con %
> - **$pr::GET_STR_EURO** : Esegue la codifica del carattere **€** in modod che non dia errore con Oracle

La funzione ritorna la stringa associata alla variabile passata come primo parametro e ne esegue la formattazione secondo i flag passati come secondo parametro.
I parametri sono dei numeri per cui per attivare più opzioni in contemporanea è sufficiente eseguirne la somma:

```php
	// recupero la variabile in maiuscolo e pronta per le query sql
	// variabile == ciao mondo com'è bello
	// $var == CIAO MONDO COM''E BELLO
	
	$var = $pr->getString( 'variabile', $pr::GET_STR_UPPER + $pr::GET_STR_SQLSAFE);
	
	$qry = "update mondo set saluto = '{$var}'";
```

### getNumber
```php
	$pr->getNumber( $iVar )
	$pr->getNumber( $iVar, $iFlags )
```

> **iVar** (*string*) : nome della variabile passata in post dal client  
> **iFlags** (*number/constants*) :
> - **$pr::GET_NUM_INT** : Ritorna solo la parte intera del numero

La funzione ritorna il valore numerico della variabile passata come primo parametro. Si occupa anche della sostituzione della virgola con il punto, in modo che sia facilmente usabile nelle query.

**NB:** La funzione ritorna il *primo* numero che trova nella variabile... il che vuol dire che se uno passa *'ciao 4'*, la funzione ritorna *'4'* e non errore o *'0'*

### getDate
```php
	$pr->getDate( $iVar )
	$pr->getDate( $iVar, $iFlags )
```

> **iVar** (*string*) : nome della variabile passata in post dal client  
> **iFlags** (*number/constants*) :
> - **$pr::GET_DATE_COBOL** : Ritorna la data nel formato *YYYYMMDD*
> - **$pr::GET_DATE_CSV** : Ritorna la data nel formato CSV standard **NON IMPLEMENTATA**

La funzione ritorna una data nel formato *DD/MM/YYYY* o *YYYYMMDD*, o `false` nel caso la variabile passata come primo parametro non contenga una data corretta.

## Funzioni per il recupero delle impostazioni si sistema

### system
```php
	$pr->system( $iVar )
```
> **iVar** (*string*) : nome della variabile di sistema

La funziona ritorna le variabili passate in json NON nel blocco `call`. Il loro uso è molto limitato e serve solo nel caso sia necessario riscrivere librerie come `response.php`.


### getDB
```php
	$pr->getDB( $iDB )
```
> **iDB** (*string*) : Nome del DB di cui si vuole la configurazione (se assente usa quello default dell'utente)

La funzione ritorna la configurazione del DB che viene passato come parametro. Se tale parametro non viene passato, allora riporta la configurazione del DB dell'utente in sessione.


### getUsr
```php
	$pr->getUsr( $iUsr )
```
> **iUsr** (*string*) : Nome dell'utente di cui si vuole la configurazione (se assente ritorna l'utente in sessione)

La funzione ritorna la configurazione dell'utente che viene passato come parametro. Se tale parametro non viene passato, allora riporta la configurazione dell'utente in sessione.

### chkGrp
```php
	$pr->chkGrp( $iGrp )
```
> **iGrp** (*string*) : nome del gruppo su cui si vuole controllare l'accesso

La funzione controlla che l'utente corrente abbia o no l'accesso al gruppo passato come parametro.

### getLocalPath
```php
	$pr->getLocalPath( $iPAth )
```
> **iPath** (*string*) : percorso del file o della direcory a cui si vuole accedere

La funziona riporta il percorso assoluto del file che viene passato come parametro a partire dalla root del modulo.
```php
	// dentro il file (/modules/xxx/mod/calls/Test.php)
	$common = $pr->getLocalPath( 'calls/_common.php' );
	
	// $common == <percorso della root del sito>/modules/xxx/mod/calls/_common.php
```

**NB:** lo scope delle della chiamate può variare a seconda che si usi `remote.php` o `Pi.RemoteLoader.php`. Queste funzione serve per slegare completamente la creazione del modulo dalla libreria usata per gestire le chiamate.

### getRootPath
```php
	$pr->getRootPath( $iPAth )
```
> **iPath** (*string*) : percorso del file o della direcory a cui si vuole accedere

La funziona riporta il percorso assoluto del file che viene passato come parametro a partire dalla root del sito.

```php
	// dentro il file (/modules/xxx/mod/calls/Test.php)
	$common = $pr->getRootPath( 'lib/PiDB.class.php' );
	
	// $common == <percorso della root del sito>/lib/PiDB.class.php
```

**NB:** lo scope delle della chiamate può variare a seconda che si usi `remote.php` o `Pi.RemoteLoader.php`. Queste funzione serve per slegare completamente la creazione del modulo dalla libreria usata per gestire le chiamate.

### set / get
```php
	$pr->set( $iKey, $iVal )
	$pr->get( $iKey )
```
> **iKey** (*string*) : nome della variabile da modificare  
> - **CloseLoader** : Gestisce la chiusura del loader modale
> 	- **true** : Il loader verrà chiuso dal client al ricevimento della risposta (**default**)  
>	- **false** : Il loader rimarrà attivo.
> - **CloseWin** : Gestisce la chiusura della finestra modale
> 	- **true** : La finestra modale verrà chiuso dal client al ricevimento della risposta (**default**)  
>	- **false** : La finestra modale rimarrà aperta.
> - **DoItBefore** : Indica quando se le operazioni *CloseLoader* e *CloseWin* debbano essere fatte. 
> 	- **true** : Le eventuali chiusure vengono fatte *prima* di tutte le altre operazioni 
>	- **false** : Le eventuali chiusure vengono fatte *dopo* tutte le altre operazioni (**default**)  
> - **CallBack** : Indica se è necessario eseguire un'altra chiamate
> 	- **true** : Deve essere seguita un'altra chiamata
>	- **false** : Tutte le chiamate sono state eseguite
> - **NextCall** : Contiene la chiamata che deve essere fatta
> - **root** : Percorso della root del sito 
>
> **iVal** (*string*) : nuovo valore della variabile

Le funzioni servono per leggere e impostare le opzioni della classe. Questi valori servono per definire il comportamento generale della classe.

**NB:** Le opzioni *CallBack*, *NextCall* e *root* sono ad uso interno e non dovrebbero essere modificate direttamente a meno che non si voglia riscrivere un gestore delle chiamate `remote.php`.

## Funzioni per impostare le azioni
Con azioni intendo le operazioni che deve eseguire il client alla risposta del server.  
Alcune di queste funzioni sono di tipo generico e visto la numerosa quantità di parametri richiesti, ne esistono versioni già preconfigurate con le impostazioni più comuni.

Le azioni vengono eseguite in sequenza e non sono esclusive. Per esempio è possibile eseguire più volte la `$pr->addHtml( ... )` per inserire html diversi all'interno della pagina.  
Altre funzioni verranno eseguite una volta sola (come `$pr->addWindow( ... )`) ma non restituiranno errori, solo che le chiamate successive alla prima verranno ignorate.

### addHtml
```php
	$pr->addHtml( $iObjId, $iContent )
	$pr->addHtml( $iObjId, $iContent, $iType )
```
> **iObjId** (*string*) : id dell'elemento html nel quale inserire il content  
> **iContent** (*string*) : Contesto in html da inserire nell'elemento selezionato  
> **itype** (*string/contast*) : tipologia di inserimento
> - **$pr::HTML_INNER** : Il contenuto dell'oggetto viene sostituito da quello passato in $iContent (**default**)
> - **$pr::HTML_APPEND** : $iContent viene accodato al contenuto già presente dell'oggetto selezionato
> - **$pr::HTML_BEFORE** : $iContent viene inserito in testa al contenuto già presente dell'oggetto selezionato

Questa funzione si occupa di iniettare dell'html all'interno della pagina web nell'elemento selezioanto